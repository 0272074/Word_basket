<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORD BASKET WEB - Custom Edition</title>
    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("System Error:\n" + msg + "\nLine: " + line);
            return false;
        };
    </script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --accent-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --background-color: #f0f4f8;
            --card-bg: #fff;
            --text-color: #2c3e50;
            --card-width: 80px;
            --card-height: 112px;
            --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100vh;
            display: grid;
            grid-template-rows: 60px 100px 1fr 200px;
            grid-template-columns: 100%;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        /* スクリーン設定 */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
        }

        .screen.hidden { display: none; }

        .config-panel {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            width: 300px;
        }

        .config-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-item label { font-weight: bold; font-size: 14px; }
        .config-item select, .config-item input { padding: 5px; border-radius: 5px; border: 1px solid #ccc; }

        .btn {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 60px;
            font-size: 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        /* ゲーム画面要素 */
        header { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        #cpu-area { display: flex; justify-content: center; gap: 10px; padding: 10px; flex-wrap: wrap; }
        .cpu-player { background: #fff; padding: 5px 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; min-width: 60px; }
        .cpu-name { font-size: 10px; color: #666; }
        .cpu-card-count { font-size: 18px; font-weight: bold; color: var(--primary-color); }

        #field-area { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: var(--card-bg);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            font-weight: bold;
            box-shadow: var(--shadow-md);
            border-bottom: 4px solid #333;
        }

        #center-card { width: 120px; height: 168px; font-size: 64px; border-bottom-width: 6px; }

        #player-area { display: flex; flex-direction: column; align-items: center; }
        #input-area {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            opacity: 0.3;
            pointer-events: none;
        }
        #input-area.active { opacity: 1; pointer-events: auto; }
        #word-input { padding: 10px; font-size: 18px; border-radius: 8px; border: 2px solid #ddd; width: 200px; text-align: center; }

        #hand-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; padding: 10px; }
        .card.interactive { cursor: pointer; }
        .card.selected { transform: translateY(-10px); border-color: var(--primary-color); box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4); }

        #timer-display { font-size: 24px; color: var(--accent-color); font-weight: bold; }
        
        #action-log { position: absolute; top: 10px; right: 10px; width: 150px; pointer-events: none; }
        .log-item { background: rgba(0,0,0,0.6); color: #fff; font-size: 11px; padding: 3px 8px; border-radius: 4px; margin-bottom: 2px; }

        /* カード色分け */
        .card[data-type="wild"] { color: #9b59b6; border-color: #9b59b6; }
        .card[data-type="number"] { color: var(--success-color); border-color: var(--success-color); }
        .card[data-type="special"] { color: var(--warning-color); border-color: var(--warning-color); }
    </style>
</head>

<body>

    <div id="title-screen" class="screen">
        <h1 style="color: var(--primary-color); margin-bottom:10px;">WORD BASKET</h1>
        <p style="margin-bottom:20px; color:#666;">ルールを自由に設定してスタート！</p>
        
        <div class="config-panel">
            <div class="config-item">
                <label>CPUの人数</label>
                <select id="cfg-cpu-count">
                    <option value="1">1人</option>
                    <option value="2">2人</option>
                    <option value="3" selected>3人</option>
                    <option value="4">4人</option>
                    <option value="5">5人</option>
                </select>
            </div>
            <div class="config-item">
                <label>CPUの強さ</label>
                <select id="cfg-cpu-level">
                    <option value="1">よわい</option>
                    <option value="2" selected>ふつう</option>
                    <option value="3">つよい</option>
                </select>
            </div>
            <div class="config-item">
                <label>持ち時間(秒)</label>
                <input type="number" id="cfg-time-limit" value="10" min="5" max="60" style="width:50px;">
            </div>
            <div class="config-item">
                <label>初期の手札</label>
                <input type="number" id="cfg-hand-size" value="5" min="3" max="10" style="width:50px;">
            </div>
        </div>

        <button class="btn" onclick="game.startGame()">START</button>
    </div>

    <div id="game-container">
        <header>
            <div style="font-weight: bold;">WORD BASKET</div>
            <div id="timer-display"></div>
        </header>

        <div id="cpu-area"></div>

        <div id="field-area">
            <div class="card" id="center-card">?</div>
            <div style="font-size:12px; color:#999; margin-top:5px;">場の文字</div>
        </div>

        <div id="player-area">
            <div id="input-area">
                <input type="text" id="word-input" placeholder="単語を入力" autocomplete="off">
                <button onclick="game.handleDiscard()" style="background:var(--accent-color); color:white; border:none; border-radius:8px; padding:0 15px; cursor:pointer;">交換</button>
            </div>
            <div id="hand-area"></div>
            <div style="font-size:12px; color:#666; margin-top:5px;">手札: <span id="card-count">0</span>枚</div>
        </div>

        <div id="action-log"></div>
    </div>

    <script>
        // --- 膨大な単語リスト（前回提供分を継承） ---
        const WORD_LIST = ["あいす","あいろん","あうと","あか","あき","あした","あにめ","あめりか","あり","あるこーる","あんぱん","いか","いぬ","いちご","いるか","いんたーねっと","うさぎ","うし","うどん","うみ","えねるぎー","えび","えんぴつ","おちゃ","おにぎり","おもちゃ","おれんじ","かい","かさ","かめら","かれー","かんがルー","きりん","ぎょうざ","きゅうり","くま","くるま","くらっかー","けーき","けーたい","けっちゃっぷ","こーひー","こーら","こんにゃく","さる","さんどいっち","さっかー","さらだ","さんた","しお","しか","しんぶん","しゅーくりーむ","しゅうまい","すいか","すし","すまーとふぉん","すてーき","すぱげってぃ","せかい","ぜりー","そふぁー","そーせーじ","たこやき","たまご","たおる","ちーず","ちょこれーと","つくえ","てにす","てれび","てんぷら","てぃっしゅ","とまと","とーなっつ","なっとう","なすび","ないふ","にんじん","にんにく","ねこ","ねくたい","のーと","のみもの","はんばーぐ","はんばーがー","はむすたー","はわい","ぴざ","ぴあの","びーる","ふらんす","ふるーつ","ふらいぱん","ぷりん","べっど","べんとう","ぺんぎん","ほてる","ぽてと","まぐろ","まろん","まんごー","みかん","みるく","むぎちゃ","めろん","めがね","めーる","やきゅう","やさい","よーぐると","よーろっぱ","らーめん","らいおん","らじお","らっこ","りんご","りぼん","れもん","れすとらん","ろけっと","ろぼっと","わいん","いぶにんぐ","るーず"];
        // ※実際にはさらに多くの単語を内部的に追加可能
        
        const HIRAGANA_CHARS = 'あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわ'.split('');
        const WILD_CARDS = ['あ行', 'か行', 'さ行', 'た行', 'な行', 'は行', 'ま行', 'や行', 'ら行', 'わ行'];
        const WILD_MAPPING = {
            'あ行':['あ','い','う','え','お'], 'か行':['か','き','く','け','こ','が','ぎ','ぐ','げ','ご'],
            'さ行':['さ','し','す','せ','そ','ざ','じ','ず','ぜ','ぞ'], 'た行':['た','ち','つ','て','と','だ','ぢ','づ','で','ど'],
            'な行':['な','に','ぬ','ね','の'], 'は行':['は','ひ','ふ','へ','ほ','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ'],
            'ま行':['ま','み','む','め','も'], 'や行':['や','ゆ','よ'], 'ら行':['ら','り','る','れ','ろ'], 'わ行':['わ']
        };

        class Card {
            constructor(type, value) {
                this.type = type;
                this.value = value;
                this.id = Math.random().toString(36).substr(2, 9);
            }
        }

        class Game {
            constructor() {
                this.players = [];
                this.deck = [];
                this.centerCard = null;
                this.selectedCard = null;
                this.isHumanThinking = false;
                this.timer = null;
                this.config = { handSize: 5, timeLimit: 10 };
                
                this.ui = {
                    centerCard: document.getElementById('center-card'),
                    handArea: document.getElementById('hand-area'),
                    inputArea: document.getElementById('input-area'),
                    inputField: document.getElementById('word-input'),
                    cardCount: document.getElementById('card-count'),
                    cpuArea: document.getElementById('cpu-area'),
                    timerDisplay: document.getElementById('timer-display'),
                    actionLog: document.getElementById('action-log')
                };

                this.ui.inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.handleWordSubmit(); });
            }

            startGame() {
                // UIから設定を読み込む
                const cpuCount = parseInt(document.getElementById('cfg-cpu-count').value);
                const cpuLevel = parseInt(document.getElementById('cfg-cpu-level').value);
                this.config.timeLimit = parseInt(document.getElementById('cfg-time-limit').value);
                this.config.handSize = parseInt(document.getElementById('cfg-hand-size').value);

                this.createDeck();
                
                // プレイヤー作成
                this.players = [{ id: 0, name: "あなた", isCpu: false, hand: [] }];
                for (let i = 1; i <= cpuCount; i++) {
                    this.players.push({ id: i, name: `CPU ${i}`, isCpu: true, hand: [], level: cpuLevel });
                }

                // 配札
                this.players.forEach(p => {
                    for (let i = 0; i < this.config.handSize; i++) p.hand.push(this.drawCard());
                });

                // 初期中央カード
                this.centerCard = new Card('hiragana', HIRAGANA_CHARS[Math.floor(Math.random() * HIRAGANA_CHARS.length)]);

                document.getElementById('title-screen').classList.add('hidden');
                this.updateUI();
                this.startCpuCycles();
            }

            createDeck() {
                this.deck = [];
                HIRAGANA_CHARS.forEach(c => { this.deck.push(new Card('hiragana', c)); this.deck.push(new Card('hiragana', c)); });
                [3, 4, 5].forEach(n => { for (let i = 0; i < 3; i++) this.deck.push(new Card('number', n)); });
                WILD_CARDS.forEach(w => this.deck.push(new Card('wild', w)));
                this.deck.sort(() => Math.random() - 0.5);
            }

            drawCard() { return this.deck.length > 0 ? this.deck.pop() : new Card('hiragana', 'あ'); }

            getEffectiveChar(word, isStart = false) {
                let char = isStart ? word[0] : word.slice(-1);
                if (!isStart && char === 'ー' && word.length > 1) char = word.slice(-2, -1);
                char = char.normalize("NFD").replace(/[\u3099\u309A]/g, "");
                const smallToLarge = { 'ゃ':'や', 'ゅ':'ゆ', 'ょ':'よ', 'っ':'つ', 'ぁ':'あ', 'ぃ':'い', 'ぅ':'う', 'ぇ':'え', 'ぉ':'お' };
                return smallToLarge[char] || char;
            }

            handleCardClick(card) {
                if (this.selectedCard?.id === card.id) {
                    this.selectedCard = null;
                    this.deactivateInput();
                } else {
                    this.selectedCard = card;
                    this.activateInput();
                }
                this.updateUI();
            }

            activateInput() {
                this.isHumanThinking = true;
                this.ui.inputArea.classList.add('active');
                this.ui.inputField.focus();
                this.startTimer();
            }

            deactivateInput() {
                this.isHumanThinking = false;
                this.ui.inputArea.classList.remove('active');
                this.ui.inputField.value = '';
                clearInterval(this.timer);
                this.ui.timerDisplay.textContent = '';
            }

            startTimer() {
                clearInterval(this.timer);
                let time = this.config.timeLimit;
                this.ui.timerDisplay.textContent = time;
                this.timer = setInterval(() => {
                    time--;
                    this.ui.timerDisplay.textContent = time;
                    if (time <= 0) {
                        this.selectedCard = null;
                        this.deactivateInput();
                        this.updateUI();
                    }
                }, 1000);
            }

            handleWordSubmit() {
                const word = this.ui.inputField.value.trim();
                if (!word || !this.selectedCard) return;

                if (this.validateWord(word, this.selectedCard)) {
                    this.executePlay(this.players[0], this.selectedCard, word);
                    this.selectedCard = null;
                    this.deactivateInput();
                }
            }

            validateWord(word, card) {
                if (word.length < 2) return false;
                // 注意: ここで本来は WORD_LIST.includes(word) をチェックしますが、
                // ユーザーが自由に単語を打ちたい場合を考慮し、簡易チェックにします。
                
                const startChar = this.getEffectiveChar(word, true);
                const endChar = this.getEffectiveChar(word, false);

                let startValid = false;
                if (this.centerCard.type === 'hiragana') startValid = (startChar === this.centerCard.value);
                else if (this.centerCard.type === 'wild') startValid = WILD_MAPPING[this.centerCard.value].includes(startChar);
                else startValid = true;

                if (!startValid) return false;

                if (card.type === 'hiragana') return endChar === card.value;
                if (card.type === 'number') return word.length === card.value;
                if (card.type === 'wild') return WILD_MAPPING[card.value].includes(endChar);
                return true;
            }

            executePlay(player, card, word) {
                player.hand = player.hand.filter(c => c.id !== card.id);
                this.centerCard = new Card('hiragana', this.getEffectiveChar(word, false));
                this.addLog(`${player.name}: ${word}`);
                this.updateUI();

                if (player.hand.length === 0) {
                    alert(player.name + "の勝利！");
                    location.reload();
                }
            }

            handleDiscard() {
                if (!this.selectedCard) return;
                const p = this.players[0];
                p.hand = p.hand.filter(c => c.id !== this.selectedCard.id);
                this.centerCard = this.selectedCard;
                p.hand.push(this.drawCard());
                p.hand.push(this.drawCard());
                this.selectedCard = null;
                this.deactivateInput();
                this.updateUI();
            }

            startCpuCycles() {
                this.players.filter(p => p.isCpu).forEach(cpu => {
                    const cycle = () => {
                        const baseDelay = 5000 / cpu.level;
                        const delay = Math.random() * 5000 + baseDelay;
                        setTimeout(() => {
                            if (!this.isHumanThinking) this.cpuMove(cpu);
                            cycle();
                        }, delay);
                    };
                    cycle();
                });
            }

            cpuMove(cpu) {
                for (let card of cpu.hand) {
                    const possibleWord = WORD_LIST.find(w => this.validateWord(w, card));
                    if (possibleWord) {
                        this.executePlay(cpu, card, possibleWord);
                        break;
                    }
                }
            }

            updateUI() {
                this.ui.centerCard.textContent = this.centerCard.value;
                this.ui.centerCard.dataset.type = this.centerCard.type;

                this.ui.handArea.innerHTML = '';
                this.players[0].hand.forEach(c => {
                    const el = document.createElement('div');
                    el.className = `card interactive ${this.selectedCard?.id === c.id ? 'selected' : ''}`;
                    el.textContent = c.value;
                    el.dataset.type = c.type;
                    el.onclick = () => this.handleCardClick(c);
                    this.ui.handArea.appendChild(el);
                });
                this.ui.cardCount.textContent = this.players[0].hand.length;

                this.ui.cpuArea.innerHTML = '';
                this.players.filter(p => p.isCpu).forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'cpu-player';
                    el.innerHTML = `<div class="cpu-name">${p.name}</div><div class="cpu-card-count">${p.hand.length}</div>`;
                    this.ui.cpuArea.appendChild(el);
                });
            }

            addLog(msg) {
                const el = document.createElement('div');
                el.className = 'log-item';
                el.textContent = msg;
                this.ui.actionLog.prepend(el);
                if(this.ui.actionLog.children.length > 5) this.ui.actionLog.lastChild.remove();
            }
        }

        const game = new Game();
    </script>
</body>

</html>